<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Bibliográfico: NovaTech</title>
  <style>
    :root {
      --bg:#020617; 
      --card:#020617; 
      --muted:#94a3b8; 
      --text:#e2e8f0; 
      --accent:#60a5fa;
      --accent-2:#34d399; 
      --danger:#fb7185; 
      --warning:#fbbf24; 
      --border:#1e293b; 
      --input-bg:#020617;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:radial-gradient(circle at top,#0f172a,#fdfdfd 55%); color:var(--text);
    }

    header{position:sticky;top:0;background:rgba(2,6,23,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:12px 16px}

    .header-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{font-size:clamp(20px,3vw,26px);margin:0 0 4px}
    .sub{color:var(--muted);font-size:13px}

    main{margin:12px 0 24px}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){
      .grid-3{grid-template-columns:1.1fr 1.1fr 1.2fr} 
      .grid-2{grid-template-columns:1fr 1fr}
    }
    .card{
      background:var(--card);border-radius:12px;border:1px solid var(--border);
      padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.8)
    }
    .card h2{margin:0 0 6px;font-size:16px}
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
    input,select,button,textarea{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      background:var(--input-bg);color:var(--text);font-size:13px
    }
    input::placeholder,textarea::placeholder{color:#64748b}
    button{
      cursor:pointer;font-weight:600;letter-spacing:.2px;
      transition:transform .08s ease,filter .08s ease
    }
    button:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn{background:linear-gradient(180deg,#020617,#020617)}
    .btn-accent{background:linear-gradient(180deg,#3b82f6,#1d4ed8);border:none}
    .btn-ok{background:linear-gradient(180deg,#10b981,#059669);border:none}
    .btn-warn{background:linear-gradient(180deg,#f59e0b,#d97706);border:none}
    .btn-danger{background:linear-gradient(180deg,#f43f5e,#e11d48);border:none}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1;min-width:0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #0f172a;text-align:left;font-size:13px}
    th{color:#9ca3af;font-weight:600}
    tr:hover td{background:#020617}
    .kpi{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr));margin-bottom:10px}
    @media (min-width:900px){ .kpi{grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))} }
    .kpi-tile{
      background:radial-gradient(circle at top,#111827,#020617);
      padding:10px;border-radius:10px;border:1px solid var(--border)
    }
    .kpi-label{font-size:11px;color:var(--muted)}
    .kpi-value{font-size:18px;font-weight:800;margin-top:2px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;
      font-size:11px;border:1px solid #1f2937;background:#020617;white-space:nowrap
    }
    .pill.ok{background:rgba(16,185,129,.12);border-color:#10b981;color:#bbf7d0}
    .pill.warn{background:rgba(245,158,11,.12);border-color:#f59e0b;color:#fed7aa}
    .pill.danger{background:rgba(244,63,94,.15);border-color:#f43f5e;color:#fecaca}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .toolbar-search{display:flex;gap:8px;flex-wrap:wrap;flex:1 1 auto;align-items:center}
    .toolbar-search input{max-width:260px}
    .toolbar-legend{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .footer{color:var(--muted);font-size:11px;text-align:center;padding:16px 0 4px}
    .nowrap{white-space:nowrap}
    .center{text-align:center}
    .small{font-size:11px}

    /* Botones en tablas */
    table button{width:auto}
    td.actions{display:flex;gap:6px;flex-wrap:wrap}

    /* VISTAS */
    .view{display:none}
    .view.active{display:block}

    /* Contenedores (volver / avanzar) */
    .step-container{display:none}
    .step-container.active{display:block}

    .step-nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;margin-bottom:10px
    }
    .step-title{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap header-row">
      <div>
        <h1 id="headerTitle">Sistema Bibliográfico: NovaTech</h1>
        <div class="sub">Gestión de Préstamos</div>
      </div>
      
      <div style="display:flex; align-items:center; gap:12px;">
          <div id="userProfileDisplay" style="text-align:right; display:none;">
              <div id="profileName" style="font-weight:600; font-size:13px; color:var(--text);">Usuario</div>
              <div id="profileRole" style="font-size:11px; color:var(--accent); text-transform:uppercase; letter-spacing:0.5px;">Rol</div>
          </div>

          <button id="btnLogout" class="btn small" style="width:auto; display:none" onclick="logout()">
            Cerrar sesión
          </button>
      </div>
    </div>
</header>

  <main class="wrap">
    <section id="viewLogin" class="card view active">
      <h2>Ingreso al sistema</h2>
      <div class="row">
        <div>
          <label>Usuario (Generalmente la primera parte del email)</label>
          <input id="loginUser" placeholder="Ej:Nombre" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="loginPass" type="password" placeholder="••••••" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn-accent" onclick="doLogin()">Ingresar</button>
        <button class="btn" onclick="clearLogin()">Borrar</button>
      </div>

      <hr style="margin:12px 0;border-color:#1f2937">

      <h3 style="font-size:14px;margin:0 0 6px">Crear Cuenta</h3>
      <div class="row">
        <div>
          <label>Nombre Completo</label>
          <input id="newFullName" placeholder="Ej: Felipe Lotas" />
        </div>
        <div>
          <label>RUT/DNI (Sin puntos, con guion. Ej: 12345678-9)</label>
          <input id="newDoc" placeholder="RUT / DNI" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Email</label>
          <input id="newEmail" type="email" placeholder="Ej: correo@universidad.cl" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="newPass" type="password" placeholder="••••••" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Rol de Usuario</label>
          <select id="newRole">
            <option value="Universitario">Universitario</option>
            <option value="Bibliotecario">Bibliotecario</option>
          </select>
        </div>
        <button class="btn-ok" onclick="registerUser()">Registrar usuario</button>
      </div>

      <p class="small muted" style="margin-top:8px">
       
      </p>
    </section>

    <div id="viewApp" class="view">
      <section class="card step-nav">
        <button id="btnPrev" class="btn small" style="width:auto" onclick="prevStep()">« Volver</button>
        <div class="step-title" id="stepLabel">Formularios</div>
        <button id="btnNext" class="btn small" style="width:auto" onclick="nextStep()">Avanzar »</button>
      </section>

      <div class="step-container" data-step="0">
        <section class="kpi">
          <div class="kpi-tile">
            <div class="kpi-label">Libros registrados</div>
            <div id="kpiBooks" class="kpi-value">0</div>
          </div>
          <div class="kpi-tile" id="tileUsers">
            <div class="kpi-label">Usuarios registrados</div>
            <div id="kpiUsers" class="kpi-value">0</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Préstamos activos</div>
            <div id="kpiLoans" class="kpi-value">0</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Ejemplares disponibles</div>
            <div id="kpiAvailable" class="kpi-value">0</div>
          </div>
        </section>

        <section class="grid grid-3">
          <div class="card" id="cardBooksForm">
            <h2>Registrar libro</h2>
            <div class="row">
              <div><label>Título</label><input id="bookTitle" placeholder="Ej:Nuevo Libro" /></div>
              <div><label>Autor</label><input id="bookAuthor" placeholder="Ej:Autor" /></div>
            </div>
            <div class="row">
              <div>
                <label>Tipo</label>
                <select id="bookType">
                  <option value="Novela">Novela</option>
                  <option value="Infantil">Infantil</option>
                  <option value="Cómic / Manga">Cómic / Manga</option>
                  <option value="Texto / Académico">Texto / Académico</option>
                  <option value="Referencia / Consulta">Referencia / Consulta</option>
                  <option value="No ficción">No ficción</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div><label>ISBN</label><input id="bookIsbn" placeholder="978-84-..." /></div>
            </div>
              <div class="row">
  <div><label>Copias</label><input id="bookQty" type="number" min="1" value="1" /></div>
  <div style="align-self:flex-end" class="row">
    
    <input type="hidden" id="editBookId" value="">

    <button class="btn-accent" id="btnSaveBook" onclick="saveBook()">Guardar</button>
    
    <button class="btn" onclick="clearBookForm()">Limpiar</button>
  </div>
</div>
          </div>

          <div class="card" id="cardUsersForm">
           <h2>Gestión de Usuarios</h2>
  
  <div class="row">
    <div>
        <label>Nombre Completo</label>
        <input id="editUserName" placeholder="Nombre Apellido" />
    </div>
    <div>
        <label>Email</label>
        <input id="editUserEmail" placeholder="correo@ejemplo.com" />
    </div>
  </div>
  
  <div class="row" style="margin-top:6px;">
    <div>
        <label>Documento (RUT/DNI)</label>
        <input id="editUserDoc" placeholder="12345678-9" />
    </div>
    
    <div style="align-self:flex-end; display:flex; gap:8px;">
        <input type="hidden" id="editUserId" value="">
        
        <button class="btn-accent" id="btnSaveUser" style="flex:1 1 auto; white-space:nowrap;" onclick="saveUser()">Guardar Cambios</button>
        <button class="btn" style="flex:0 0 auto;" onclick="clearUserForm()">Limpiar</button>
    </div>
  </div>
  <p class="muted small" style="margin-top:4px; margin-bottom:0;">* Para crear nuevos usuarios, usa la pantalla de Login.</p>
</div>

<div class="card" id="cardLoansForm">
    <h2>Registrar préstamo</h2>
    <div class="row">
      <div><label>Libro</label><select id="loanBook"></select></div>
      <div id="loanUserField">
        <label>Usuario</label>
        <select id="loanUser"></select>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <div><label>Fecha de préstamo</label><input id="loanDate" type="date" /></div>
      <div><label>Fecha estimada devolución</label><input id="loanDue" type="date" /></div>
    </div>
    
    <div class="row" style="margin-top:6px; display:flex; gap:8px;">
      <input type="hidden" id="editLoanId" value="">
      
      <button class="btn-warn" id="btnSaveLoan" style="flex:1 1 auto;" onclick="saveLoan()">Prestar</button>
      
      <button class="btn" style="flex:0 0 auto;" onclick="clearLoanForm()">Limpiar</button>
      <button class="btn" style="flex:0 0 auto;" onclick="suggestDue()">+ 14 días</button>
    </div>
</div>
        </section>
      </div>

      <div class="step-container" data-step="1">
        <section class="card" style="margin-top:10px">
          <div class="toolbar">
            <div class="toolbar-search">
              <input id="search" placeholder="Buscar en libros, usuarios y préstamos…" oninput="renderAll()" />
              <button id="btnToolbarSearchLink" class="btn-accent small" style="width:auto" onclick="toolbarSearchBookLink()">Buscar Link Externo</button>
            </div>
            <div class="toolbar-legend">
              <span class="pill ok">Disponible</span>
              <span class="pill warn">Prestado</span>
              <span class="pill danger">Atrasado</span>
            </div>
          </div>

          <div class="grid grid-2" style="margin-top:10px">
            <div>
              <h2 style="margin-bottom:4px">Libros</h2>
              <table id="tblBooks">
                <thead>
                  <tr>
                    <th>Título</th><th>Autor</th><th>Tipo</th>
                    <th class="nowrap">Copias</th><th class="nowrap">Disp.</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="usersTableContainer">
              <h2 style="margin-bottom:4px">Usuarios</h2>
              <table id="tblUsers">
                <thead>
                  <tr><th>Nombre</th><th>Documento</th><th>Préstamos activos</th><th></th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <div class="step-container" data-step="2" id="loansStepContainer">
        <section class="card" style="margin-top:10px">
          <h2 id="loansTitle">Préstamos</h2>
          <table id="tblLoans">
            <thead>
              <tr><th>Libro</th><th>Usuario</th><th>Salida</th><th>Vence</th><th>Estado</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <table id="tblUserLoans" style="display:none">
            <thead>
              <tr><th>Libro</th><th>Salida</th><th>Vence</th><th>Estado</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </div>

      <section class="footer">
        <div>Sistema Bibliográfico: NovaTech - Derechos reservados.</div>
      </section>
    </div>
  </main>

  <script>
    
    const $ = (s,root=document)=>root.querySelector(s);
    const todayISO = () => new Date().toLocaleDateString('en-CA');
    const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);

function updateProfileUI() {
    const profileDiv = $("#userProfileDisplay");
    
    if (currentAccount) {
        // 1. Poner Nombre
        $("#profileName").textContent = currentAccount.name || currentAccount.username;
        
        // 2. Poner Rol y Color
        const roleSpan = $("#profileRole");
        roleSpan.textContent = currentAccount.role;
        
        if(currentAccount.role === "Bibliotecario"){
            roleSpan.style.color = "#60a5fa"; // Azul (var(--accent))
        } else {
            roleSpan.style.color = "#34d399"; // Verde (var(--accent-2))
        }

        // 3. Mostrar el bloque
        profileDiv.style.display = "block";
    } else {
        // Si no hay usuario, ocultar
        profileDiv.style.display = "none";
    }
}
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              let cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    let books = [];
    let users = [];
    let loans = [];
    let currentAccount = null;
    
    let sessionLoaded = false; 

    function isAdmin() {
      return currentAccount && currentAccount.role === "Bibliotecario";
    }

    function getCurrentUserId() {
        return currentAccount ? currentAccount.id : null;
    }
    
    function runWithCallback(nombreAccion, callback){
      console.log("Ejecutando acción:", nombreAccion);
      if(typeof callback === "function"){ callback(); }
    }


    function validateEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }

    function validateRUT(rut) {
        if (typeof rut !== 'string' || !/^\d{7,8}-[\dkK]$/.test(rut)) return false;

        let [body, checkDigit] = rut.split('-');
        body = parseInt(body, 10);
        checkDigit = checkDigit.toUpperCase();

        let sum = 0;
        let multiplier = 2;

        for (let i = body.toString().length - 1; i >= 0; i--) {
            sum += parseInt(body.toString().charAt(i), 10) * multiplier;
            multiplier = multiplier === 7 ? 2 : multiplier + 1;
        }

        const calculatedCheckDigit = 11 - (sum % 11);
        let expectedCheckDigit = calculatedCheckDigit === 11 ? '0' : calculatedCheckDigit === 10 ? 'K' : calculatedCheckDigit.toString();

        return expectedCheckDigit === checkDigit;
    }

    function applyRolePermissions() {
      const isA = isAdmin();
      
      $("#cardBooksForm").style.display = isA ? "block" : "none";
      $("#cardUsersForm").style.display = isA ? "block" : "none";

      if ($("#tileUsers")) {
        $("#tileUsers").style.display = isA ? "block" : "none";
    }
      
      const loanUserField = $("#loanUserField");
      if (loanUserField) {
        loanUserField.style.display = isA ? "block" : "none";
      }

      const step0Container = document.querySelector(".step-container[data-step='0'] .grid-3");
      if (step0Container) {
          step0Container.style.gridTemplateColumns = isA ? "1.1fr 1.1fr 1.2fr" : "1fr";
          if (!isA) {
              $("#cardLoansForm").style.gridColumn = "1 / -1"; 
          } else {
              $("#cardLoansForm").style.gridColumn = ""; 
          }
      }

      const usersTableContainer = $("#usersTableContainer");
      const tableGrid = document.querySelector(".step-container[data-step='1'] .grid-2");
      
      if (usersTableContainer) {
          usersTableContainer.style.display = isA ? "block" : "none";
      }
      if (tableGrid) {
          tableGrid.style.gridTemplateColumns = isA ? "1fr 1fr" : "1fr";
      }

      $("#tblLoans").style.display = isA ? "table" : "none"; 
      $("#tblUserLoans").style.display = isA ? "none" : "table"; 
      $("#loansTitle").textContent = isA ? "Historial de Préstamos" : "Mis Préstamos";

      renderAll();
      showStep(0); 
    }

    
    // --- NAVEGACIÓN ---
    
    let currentStep = 0;
    function showStep(idx){
      const steps = document.querySelectorAll(".step-container");
      if(!steps.length) return;
      
      const maxStep = steps.length - 1; 

      if(idx < 0) idx = 0;
      if(idx > maxStep) idx = maxStep; 
      
      currentStep = idx;
      steps.forEach((s,i)=>s.classList.toggle("active", i===currentStep));

      const titles = [
        "Formularios",
        "Libros y usuarios",
        isAdmin() ? "Historial de Préstamos" : "Mis Préstamos" 
      ];
      $("#stepLabel").textContent = titles[currentStep] || `Vista ${currentStep+1}`;
      $("#btnPrev").disabled = currentStep === 0;
      $("#btnNext").disabled = currentStep === maxStep;
      
      if(currentStep === 2) {
        loadInitialData(true); 
      } else {
        renderAll();
      }
    }
    function prevStep(){ showStep(currentStep - 1); }
    function nextStep(){ showStep(currentStep + 1); }

    
    // --- AUTENTICACIÓN ---
    

    async function checkSession() {
        try {
            const response = await fetch('/api/check_session/'); 
            const data = await response.json();

            if (data.is_authenticated) {
                currentAccount = {
                    id: data.user_id,
                    role: data.role,
                    name: data.full_name,
                    doc: data.doc
                };

                updateProfileUI();
                
                $("#viewLogin").classList.remove("active");
                $("#viewApp").classList.add("active");
                $("#btnLogout").style.display = "inline-flex";
                
                await loadInitialData();
                applyRolePermissions();
            } else {
                $("#viewLogin").classList.add("active");
                $("#viewApp").classList.remove("active");
                $("#btnLogout").style.display = "none";
            }
        } catch (error) {
            console.error("Error al verificar la sesión:", error);
            $("#viewLogin").classList.add("active");
            $("#viewApp").classList.remove("active");
        }
        sessionLoaded = true;
    }

    async function doLogin(){
      const username = $("#loginUser").value.trim();
      const password = $("#loginPass").value.trim();

      if(!username || !password){
        alert("Debes ingresar usuario y contraseña.");
        return;
      }
      
      try {
        const response = await fetch('/api/login/', { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') 
          },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          currentAccount = { 
            id: data.user_id, 
            role: data.role, 
            name: data.full_name, 
            doc: data.doc 
          };
          
          updateProfileUI();
          
          runWithCallback("login", async () => {
            $("#viewLogin").classList.remove("active");
            $("#viewApp").classList.add("active");
            $("#btnLogout").style.display = "inline-flex";
            await loadInitialData(); 
            applyRolePermissions(); 
          });
        } else {
          alert(data.message || "Usuario o contraseña incorrectos.");
        }
      } catch (error) {
        console.error('Error de red o servidor:', error);
        alert("Error al conectar con el servidor. Asegúrate de que Django esté corriendo.");
      }
    }

    async function registerUser(){
      const full_name = $("#newFullName").value.trim();
      const doc = $("#newDoc").value.trim(); 
      const email = $("#newEmail").value.trim(); 
      const password = $("#newPass").value.trim();
      const role = $("#newRole").value; 
      const username = email.split('@')[0]; 

      if(!full_name || !doc || !email || !password){ 
        alert("Todos los campos son obligatorios.");
        return;
      }
      if (!validateEmail(email)) {
          alert("El formato del Email no es válido.");
          return;
      }
      if (role === 'Universitario' && !validateRUT(doc)) {
          alert("El formato o dígito verificador del RUT/DNI es inválido.");
          return;
      }
      
      try {
        const response = await fetch('/api/register/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ full_name, doc, email, password, role, username })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            $("#newFullName").value = "";
            $("#newDoc").value = "";
            $("#newEmail").value = "";
            $("#newPass").value = "";
            $("#newRole").value = "Universitario"; 

            alert("Usuario creado. Tu nombre de acceso es '"+username+"'. Ahora puedes iniciar sesión.");
            
            if (isAdmin()) {
                await loadInitialData(); 
            }
        } else {
            alert(data.message || "Error al registrar el usuario.");
        }

      } catch (error) {
        console.error('Error de red o servidor:', error);
        alert("Error al conectar con el servidor.");
      }
    }

    function clearLogin(){
      $("#loginUser").value = "";
      $("#loginPass").value = "";
    }

    async function logout(){
      try {
        await fetch('/api/logout/', { 
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
      } catch (e) {
        console.warn("Error al llamar a logout en la API, continuando con logout local:", e);
      }
      
      runWithCallback("logout", () => {
        currentAccount = null;

        updateProfileUI();

        books = [];
        users = [];
        loans = [];
        $("#viewApp").classList.remove("active");
        $("#viewLogin").classList.add("active");
        $("#btnLogout").style.display = "none";
        clearLogin();
      });
    }

   
    // --- CARGA INICIAL DE DATOS (AHORA USA API DJANGO) ---
  
    async function loadInitialData(forceReloadLoans = false){
        if (!getCurrentUserId()) return; 
        const isA = isAdmin();
        const userId = getCurrentUserId();
        
        try {
            const booksResponse = await fetch('/api/books/');
            books = await booksResponse.json();
            
            if (isA) {
                const usersResponse = await fetch('/api/users/');
                users = await usersResponse.json();
            } else {
                users = [];
            }
            
            let loansEndpoint = isA ? '/api/loans/all/' : `/api/loans/user/${userId}/`;
            
            if (forceReloadLoans || loans.length === 0) {
              const loansResponse = await fetch(loansEndpoint);
              loans = await loansResponse.json();
            }
            
            renderAll();
        } catch (error) {
            console.error("Error al cargar datos iniciales:", error);
            alert("No se pudieron cargar los datos del sistema. Revisa la conexión con el servidor.");
        }
    }

    // --- CRUD LIBROS ---

    async function saveBook(){
    if (!isAdmin()) {
      alert("Solo el bibliotecario puede gestionar libros.");
      return;
    }

    const id = $("#editBookId").value; 
    const isEdit = id !== "";          

    const title = $("#bookTitle").value.trim();
    const author = $("#bookAuthor").value.trim();
    const isbn = $("#bookIsbn").value.trim();
    const type = $("#bookType").value;
    const qtyVal = $("#bookQty").value || "1";
    const qty = Math.max(1, parseInt(qtyVal, 10));

    if(!title || !author){ 
      alert("Título y Autor son obligatorios."); 
      return; 
    }

    const url = isEdit ? `/api/books/${id}/edit/` : '/api/books/add/';
    const actionName = isEdit ? "editarLibro" : "guardarLibro";
    const payload = { 
        titulo: title, 
        autor: author, 
        genero: type, 
        cantidad: qty, 
        isbn: isbn 
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (response.ok && data.success) {
            runWithCallback(actionName, async () => {
                clearBookForm();       
                await loadInitialData(); 
                alert(isEdit ? "Libro actualizado correctamente." : "Libro creado correctamente.");
            });
        } else {
            alert(data.message || "Error al procesar.");
        }
    } catch (error) {
        console.error(error);
        alert("Error de conexión con el servidor.");
    }
}

    function clearBookForm(){
    $("#bookTitle").value="";
    $("#bookAuthor").value="";
    $("#bookIsbn").value="";
    $("#bookQty").value=1;
    $("#bookType").value="Novela";
    $("#editBookId").value = ""; 
    $("#btnSaveBook").textContent = "Guardar";
}

//  EDITAR USUARIOS

async function saveUser(){
    if (!isAdmin()) return;

    const id = $("#editUserId").value;
    
    if(!id){
        alert("Para crear un usuario nuevo, por favor cierra sesión y usa la opción 'Crear Cuenta' en la pantalla de inicio.");
        return;
    }

    const name = $("#editUserName").value.trim();
    const email = $("#editUserEmail").value.trim();
    const doc = $("#editUserDoc").value.trim();

    if(!name){ alert("El nombre es obligatorio."); return; }

    try {
        const response = await fetch(`/api/users/${id}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ name, email, doc })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            runWithCallback("editarUsuario", async () => {
                clearUserForm();
                await loadInitialData(); 
                alert("Usuario actualizado correctamente.");
            });
        } else {
            alert(data.message || "Error al editar.");
        }
    } catch (error) {
        console.error(error);
        alert("Error de conexión con el servidor.");
    }
}

function clearUserForm(){
    $("#editUserName").value = "";
    $("#editUserEmail").value = "";
    $("#editUserDoc").value = "";
    $("#editUserId").value = "";
}

    async function deleteBook(id){
      if (!isAdmin()) {
        alert("Solo el bibliotecario puede eliminar libros.");
        return;
      }

      if(!confirm("¿Estás seguro de eliminar este libro?")) return;
      
      try {
        const response = await fetch(`/api/books/${id}/delete/`, { 
          method: 'DELETE',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        });

        const data = await response.json();

        if (response.ok && data.success) {
          runWithCallback("eliminarLibro", async () => {
            await loadInitialData(); 
          });
        } else {
          alert(data.message || "No se pudo eliminar el libro. Puede tener préstamos activos.");
        }
      } catch (error) {
        console.error('Error al eliminar libro:', error);
        alert("Error de conexión al servidor.");
      }
    }

    // --- CRUD USUARIOS ---

    function addUser(){
       alert("El registro de usuarios ahora se realiza únicamente en la pantalla de Inicio de Sesión (Crear Cuenta).");
    }

    async function deleteUser(id){
      if (!isAdmin()) {
        alert("Solo el bibliotecario puede eliminar usuarios.");
        return;
      }

      if(!confirm("¿Estás seguro de eliminar este usuario?")) return;
      
      try {
        const response = await fetch(`/api/users/${id}/delete/`, { 
          method: 'DELETE',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        });

        const data = await response.json();

        if (response.ok && data.success) {
          runWithCallback("eliminarUsuario", async () => {
            await loadInitialData(); 
          });
        } else {
          alert(data.message || "No se pudo eliminar el usuario. Puede tener préstamos activos.");
        }
      } catch (error) {
        console.error('Error al eliminar usuario:', error);
        alert("Error de conexión al servidor.");
      }
    }

    // --- CRUD PRÉSTAMOS ---

function availableCopies(bookId){
  const id = parseInt(bookId);
  const book = books.find(b => b.id === id); 
  if(!book) return 0;
  
  const borrowed = loans.filter(l => l.libro.id === id && l.is_activo).length;
  return Math.max(0, (book.cantidad || 0) - borrowed);
}
    


async function saveLoan(){
    const bookId = parseInt($("#loanBook").value);
    
    let userId;
    if (isAdmin()) {
        userId = $("#loanUser").value;
    } else {
        userId = getCurrentUserId();
    }
    
    const outAt = $("#loanDate").value || todayISO();
    const dueAt = $("#loanDue").value || addDays(outAt, 14);
    
    const id = $("#editLoanId").value;
    const isEdit = id !== "";

    if(!bookId || !userId){
       alert("Debes seleccionar un libro y un usuario.");
       return;
    }

    // REGLA DE LOS 14 DÍAS MÁXIMOS

    const dStart = new Date(outAt);
    const dEnd = new Date(dueAt);
    const diffTime = dEnd - dStart; 
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

    if (diffDays < 0) {
        alert("La fecha de devolución no puede ser anterior a la fecha de préstamo.");
        return;
    }

    if (diffDays > 14) {
        alert("El plazo máximo es de 14 días.");
        return; 
    }

    if (!isEdit && availableCopies(bookId) <= 0) { 
       alert("No hay copias disponibles para este libro.");
       return;
    }
    
    const url = isEdit ? `/api/loans/${id}/edit/` : '/api/loans/add/';
    const actionName = isEdit ? "editarPrestamo" : "prestarLibro";

    const payload = { 
        libro_id: bookId, 
        universitario_id: userId, 
        fch_prestamo: outAt, 
        fch_devolucion: dueAt 
    };

    try {
       const response = await fetch(url, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
           'X-CSRFToken': getCookie('csrftoken')
         },
         body: JSON.stringify(payload)
       });

       const data = await response.json();

       if (response.ok && data.success) {
         runWithCallback(actionName, async () => {
           await loadInitialData(true); 
           clearLoanForm(); 
           alert(isEdit ? "Préstamo actualizado." : "Préstamo registrado.");
           
           if (!isAdmin()) showStep(2);
         });
       } else {
         alert(data.message || "Error al realizar la operación.");
       }
     } catch (error) {
       console.error(error);
       alert("Error de conexión al servidor.");
     }
}

function clearLoanForm(){
    $("#loanBook").value = "";
    $("#loanUser").value = "";
    $("#loanDate").value = todayISO();
    $("#loanDue").value = addDays(todayISO(), 14);
    
    $("#editLoanId").value = "";
    $("#btnSaveLoan").textContent = "Prestar";
    $("#loanBook").disabled = false;
    }
 
    async function returnLoan(id){
      
      if(!confirm("¿Confirmas la devolución de este libro?")) return;

      try {
        const response = await fetch(`/api/loans/${id}/return/`, { 
          method: 'POST',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        });

        const data = await response.json();

        if (response.ok && data.success) {
          runWithCallback("devolverLibro", async () => {
            await loadInitialData(true); 
          });
        } else {
          alert(data.message || "Error al procesar la devolución.");
        }
      } catch (error) {
        console.error('Error al devolver libro:', error);
        alert("Error de conexión al servidor.");
      }
    }
    
    // --- GOOGLE BOOKS API ---
    
    function searchBookLinkByQuery(query) {
        const q = query.trim();
        if (!q) {
            alert("Ingresa un título o ISBN en el campo de búsqueda para buscar un enlace externo.");
            return;
        }

        const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=1`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Error de red o API.");
                return response.json();
            })
            .then(data => {
                if (data.items && data.items.length > 0) {
                    const item = data.items[0].volumeInfo;
                    const link = item.infoLink || item.previewLink;
                    const title = item.title || 'Desconocido';
                    const authors = item.authors ? item.authors.join(', ') : 'Desconocido';

                    if (link) {
                        if(confirm(`Se encontró información externa para: "${title}" (Autor: ${authors}). ¿Deseas abrir el enlace de vista previa/información?`)) {
                            window.open(link, '_blank');
                        }
                    } else {
                        alert(`Se encontró el libro "${title}" pero no tiene un enlace de vista previa/información disponible.`);
                    }
                } else {
                    alert(`No se encontró información en la API de Google Books para la búsqueda "${q}".`);
                }
            })
            .catch(error => {
                console.error('Error al buscar el libro:', error);
                alert("Ocurrió un error al intentar buscar el enlace externo.");
            });
    }

    function toolbarSearchBookLink() {
        const query = $("#search").value.trim();
        searchBookLinkByQuery(query);
    }

    // --- RENDERIZADO ---

    function renderAll(){
      renderCombos();
      renderKpis();
      renderBooks();
      renderUsers();
      if (currentStep === 2) {
        if (isAdmin()) {
          renderLoans(); 
        } else {
          renderUserLoans(); 
        }
      }
    }
    function renderCombos(){
      const bookSel=$("#loanBook"), userSel=$("#loanUser");
      
      bookSel.innerHTML='<option value="">— Selecciona —</option>'+books.map(b=>{
        const disp=availableCopies(b.id), type=b.genero||"—"; 
        return `<option value="${b.id}">${escapeHtml(b.titulo)} (${escapeHtml(type)}) — ${disp}/${b.cantidad} disp.</option>`;
      }).join("");
      
      userSel.innerHTML='<option value="">— Selecciona —</option>'+users.map(u=>
        `<option value="${u.id}">${escapeHtml(u.name)} (${escapeHtml(u.doc)})</option>`
      ).join("");
    }
    
    function renderKpis(){
      const active=loans.filter(l=>l.is_activo).length;
      const available=books.reduce((acc,b)=>acc+availableCopies(b.id),0);
      $("#kpiBooks").textContent=books.length;
      $("#kpiUsers").textContent=users.length;
      $("#kpiLoans").textContent=active;
      $("#kpiAvailable").textContent=available;
    }
    
    function renderBooks(){
      const q=($("#search")?.value||"").toLowerCase();
      const tb=document.querySelector("#tblBooks tbody"); if(!tb) return;
      tb.innerHTML="";
      
      const isA = isAdmin(); 
      
      books
        .filter(b=>!q?true:[b.titulo,b.autor,b.isbn,b.genero].some(x=>(x||"").toLowerCase().includes(q)))
        .forEach(b=>{
          const actionsHtml = isA
            ? `
              <button class="btn small" onclick="editBookPrompt('${b.id}')">Editar</button>
              <button class="btn-danger small" onclick="deleteBook('${b.id}')">Eliminar</button>
              `
            : ""; 
          
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${escapeHtml(b.titulo)}</td>
            <td>${escapeHtml(b.autor)}</td>
            <td>${escapeHtml(b.genero||"—")}</td>
            <td>${b.cantidad}</td>
            <td>${availableCopies(b.id)}</td>
            <td class="actions">
              ${actionsHtml}
            </td>`;
          tb.appendChild(tr);
        });
    }
    
    function renderUsers(){
      if (!isAdmin()) return; 
      
      const q=($("#search")?.value||"").toLowerCase();
      const tb=document.querySelector("#tblUsers tbody"); if(!tb) return;
      tb.innerHTML="";
      users
        .filter(u=>!q?true:[u.name,u.doc].some(x=>(x||"").toLowerCase().includes(q)))
        .forEach(u=>{
          const count=loans.filter(l=>l.universitario.id===u.id && l.is_activo).length; 
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${escapeHtml(u.name)}</td>
            <td>${escapeHtml(u.doc)}</td>
            <td>${count}</td>
            <td class="actions">
              <button class="btn small" onclick="editUserPrompt('${u.id}')">Editar</button>
              <button class="btn-danger small" onclick="deleteUser('${u.id}')">Eliminar</button>
            </td>`;
          tb.appendChild(tr);
        });
    }

    function renderLoans(){
      if (!isAdmin()) return; 
      
      const q=($("#search")?.value||"").toLowerCase();
      const tb=document.querySelector("#tblLoans tbody"); if(!tb) return;
      tb.innerHTML="";
      
      loans
        .filter(l=>{
          if(!q) return true;
          return [l.libro.titulo, l.universitario.name, l.fch_prestamo, l.fch_devolucion]
            .some(x=>(x||"").toLowerCase().includes(q));
        })
        .sort((a,b)=>(b.is_activo?1:0)-(a.is_activo?1:0)) 
        .forEach(l=>{
          const status=loanStatus(l);
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${escapeHtml(l.libro?.titulo||"—")}</td>
            <td>${escapeHtml(l.universitario?.name||"—")}</td>
            <td>${fmtDate(l.fch_prestamo)}</td>
            <td>${fmtDate(l.fch_devolucion)}</td>
            <td>${statusBadge(status)}</td>
            <td class="actions">
              ${l.is_activo?`<button class="btn-ok small" onclick="returnLoan('${l.id}')">Devolver</button>`:""}
              <button class="btn small" onclick="editLoanPrompt('${l.id}')">Editar</button>
              <button class="btn-danger small" onclick="deleteLoan('${l.id}')">Eliminar</button>
            </td>`;
          tb.appendChild(tr);
        });
    }

    function renderUserLoans(){
        if (isAdmin() || !getCurrentUserId()) return; 

        const tb=document.querySelector("#tblUserLoans tbody"); if(!tb) return;
        tb.innerHTML="";
        
        loans
            .sort((a,b)=>(b.is_activo?1:0)-(a.is_activo?1:0)) 
            .forEach(l => {
                const status = loanStatus(l);
                const tr = document.createElement("tr");
                const actionButton = l.is_activo 
                    ? `<td class="actions"><button class="btn-ok small" onclick="returnLoan('${l.id}')">Devolver</button></td>` 
                    : `<td></td>`;

                tr.innerHTML = `
                    <td>${escapeHtml(l.libro?.titulo || "—")}</td>
                    <td>${fmtDate(l.fch_prestamo)}</td>
                    <td>${fmtDate(l.fch_devolucion)}</td>
                    <td>${statusBadge(status)}</td>
                    ${actionButton}
                `;
                tb.appendChild(tr);
            });
    }

    function statusBadge(s){
      const cls=s==="Atrasado"?"danger":(s==="Prestado"?"warn":"ok");
      return `<span class="pill ${cls}">${s}</span>`;
    }
    
    function loanStatus(l){
      if(!l.is_activo && l.fch_devolucion_real) return "Devuelto";
      
      const now=todayISO();
      return l.fch_devolucion<now?"Atrasado":"Prestado"; 
    }
    
    function fmtDate(iso){
      if(!iso) return "—";
      const [y,m,d]=iso.split("-");
      return `${d}/${m}/${y}`;
    }
    function addDays(dateISO,days){
      const d=new Date(dateISO); d.setDate(d.getDate()+days);
      return d.toISOString().slice(0,10);
    }
    function suggestDue(){
      const d=$("#loanDate").value||todayISO();
      $("#loanDate").value=d;
      $("#loanDue").value=addDays(d,14);
    }
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g,m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function editBookPrompt(id){
    const book = books.find(b => b.id == id);
    if(!book) return;

    $("#bookTitle").value = book.titulo;
    $("#bookAuthor").value = book.autor;
    $("#bookIsbn").value = book.isbn;
    $("#bookType").value = book.genero;
    $("#bookQty").value = book.cantidad;
    $("#editBookId").value = book.id;
    $("#btnSaveBook").textContent = "Actualizar Libro";
    showStep(0);
}
    
      function editUserPrompt(id){
    const user = users.find(u => u.id == id);
    if(!user) return;
    $("#editUserName").value = user.name;
    $("#editUserDoc").value = user.doc;
    $("#editUserId").value = user.id;
    $("#editUserEmail").value = ""; 

    showStep(0); 
    
    $("#cardUsersForm").style.borderColor = "#fbbf24";
    setTimeout(()=>$("#cardUsersForm").style.borderColor = "var(--border)", 2000);
}
    function editLoanPrompt(id){
    const loan = loans.find(l => l.id == id);
    if(!loan) return;

    $("#loanBook").value = loan.libro.id;
    $("#loanUser").value = loan.universitario.id; 

    if(loan.fch_prestamo) $("#loanDate").value = loan.fch_prestamo.slice(0,10);
    if(loan.fch_devolucion) $("#loanDue").value = loan.fch_devolucion.slice(0,10);

    $("#editLoanId").value = loan.id;
    $("#btnSaveLoan").textContent = "Actualizar Préstamo";
    $("#loanBook").disabled = false; 

    showStep(0);
    $("#cardLoansForm").style.borderColor = "#fbbf24";
    setTimeout(()=>$("#cardLoansForm").style.borderColor = "var(--border)", 2000);
}
    async function deleteLoan(id){
      if (!isAdmin()) {
        alert("Solo el bibliotecario puede eliminar préstamos.");
        return;
      }
      if(!confirm("¿Estás seguro de eliminar este préstamo?")) return;
      
      try {
        const response = await fetch(`/api/loans/${id}/delete/`, {
          method: 'DELETE',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        });

        const data = await response.json();

        if (response.ok && data.success) {
          runWithCallback("eliminarPrestamo", async () => {
            await loadInitialData(true); 
          });
        } else {
          alert(data.message || "Error al eliminar el préstamo.");
        }
      } catch (error) {
        console.error('Error al eliminar préstamo:', error);
        alert("Error de conexión al servidor.");
      }
    }


    // Init
    (function init(){
      $("#loanDate").value=todayISO();
      $("#loanDue").value=addDays(todayISO(),14);
      checkSession(); 
    })();
  </script>
</body>
</html>