# Este archivo maneja la lógica de auditoría y las interacciones complejas
# que no deben ir directamente en la vista.

import sqlite3
from datetime import datetime
import requests
from requests.exceptions import RequestException

# --- CONSTANTES ---
# Asegúrate de que este sea el nombre de tu archivo de base de datos SQLite
DB_NAME = 'biblioteca.db' 

# --- FUNCIÓN DE AUDITORÍA ---

def log_auditoria(usuario_id, accion, tabla_afectada, detalle):
    """Registra una acción importante en la tabla de auditoría (SQLite)."""
    try:
        # Uso de 'with' para asegurar que la conexión se cierre automáticamente
        with sqlite3.connect(DB_NAME) as conn:
            c = conn.cursor()
            fch_actual = datetime.now().strftime('%Y-%m-%d %H:%M:%S') 
            c.execute("INSERT INTO auditoria (usuario_id, accion, tabla_afectada, detalle, fecha) VALUES (?, ?, ?, ?, ?)",
                      (usuario_id, accion, tabla_afectada, detalle, fch_actual))
            conn.commit()
    except sqlite3.Error as e:
        # Esto debería enviarse a un logger, pero por simplicidad lo imprimimos
        print(f"ERROR DE AUDITORÍA: No se pudo registrar la acción. {e}")


# --- FUNCIÓN DE API EXTERNA ---

def get_valor_uf():
    """Obtiene el valor actual de la UF de la API de Mindicador (para multas)."""
    url = "https://mindicador.cl/api/uf"
    try:
        response = requests.get(url, timeout=3)
        response.raise_for_status()
        data = response.json()
        # El valor de la UF se encuentra en la primera posición del array 'serie'
        if data and 'serie' in data and data['serie']:
            return data['serie'][0]['valor']
        return 0.0
    except RequestException as e:
        print(f"Alerta: Error al conectar con la API de indicadores. Multa calculada en 0. {e}")
        return 0.0
    except Exception:
        return 0.0