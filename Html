<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Préstamo de Libros</title>
  <style>
    :root {
      --bg:#020617; 
      --card:#020617; 
      --muted:#94a3b8; 
      --text:#e2e8f0; 
      --accent:#60a5fa;
      --accent-2:#34d399; 
      --danger:#fb7185; 
      --warning:#fbbf24; 
      --border:#1e293b; 
      --input-bg:#020617;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:radial-gradient(circle at top,#0f172a,#fdfdfd 55%); color:var(--text);
    }

    header{position:sticky;top:0;background:rgba(2,6,23,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:12px 16px}

    .header-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{font-size:clamp(20px,3vw,26px);margin:0 0 4px}
    .sub{color:var(--muted);font-size:13px}

    main{margin:12px 0 24px}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){
      .grid-3{grid-template-columns:1.1fr 1.1fr 1.2fr}
      .grid-2{grid-template-columns:1fr 1fr}
    }
    .card{
      background:var(--card);border-radius:12px;border:1px solid var(--border);
      padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.8)
    }
    .card h2{margin:0 0 6px;font-size:16px}
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
    input,select,button,textarea{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      background:var(--input-bg);color:var(--text);font-size:13px
    }
    input::placeholder,textarea::placeholder{color:#64748b}
    button{
      cursor:pointer;font-weight:600;letter-spacing:.2px;
      transition:transform .08s ease,filter .08s ease
    }
    button:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn{background:linear-gradient(180deg,#020617,#020617)}
    .btn-accent{background:linear-gradient(180deg,#3b82f6,#1d4ed8);border:none}
    .btn-ok{background:linear-gradient(180deg,#10b981,#059669);border:none}
    .btn-warn{background:linear-gradient(180deg,#f59e0b,#d97706);border:none}
    .btn-danger{background:linear-gradient(180deg,#f43f5e,#e11d48);border:none}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1;min-width:0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #0f172a;text-align:left;font-size:13px}
    th{color:#9ca3af;font-weight:600}
    tr:hover td{background:#020617}
    .kpi{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr));margin-bottom:10px}
    @media (min-width:900px){ .kpi{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .kpi-tile{
      background:radial-gradient(circle at top,#111827,#020617);
      padding:10px;border-radius:10px;border:1px solid var(--border)
    }
    .kpi-label{font-size:11px;color:var(--muted)}
    .kpi-value{font-size:18px;font-weight:800;margin-top:2px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;
      font-size:11px;border:1px solid #1f2937;background:#020617;white-space:nowrap
    }
    .pill.ok{background:rgba(16,185,129,.12);border-color:#10b981;color:#bbf7d0}
    .pill.warn{background:rgba(245,158,11,.12);border-color:#f59e0b;color:#fed7aa}
    .pill.danger{background:rgba(244,63,94,.15);border-color:#f43f5e;color:#fecaca}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .toolbar-search{display:flex;gap:8px;flex-wrap:wrap;flex:1 1 auto;align-items:center}
    .toolbar-search input{max-width:260px}
    .toolbar-legend{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .footer{color:var(--muted);font-size:11px;text-align:center;padding:16px 0 4px}
    .nowrap{white-space:nowrap}
    .center{text-align:center}
    .small{font-size:11px}

    /* Botones en tablas */
    table button{width:auto}
    td.actions{display:flex;gap:6px;flex-wrap:wrap}

    /* VISTAS */
    .view{display:none}
    .view.active{display:block}

    /* Contenedores (volver / avanzar) */
    .step-container{display:none}
    .step-container.active{display:block}

    .step-nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;margin-bottom:10px
    }
    .step-title{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap header-row">
      <div>
        <h1>Bienvenido</h1>
        <div class="sub">Biblioteca Virtual</div>
      </div>
      <button id="btnLogout" class="btn small" style="width:auto;display:none" onclick="logout()">
        Cerrar sesión
      </button>
    </div>
  </header>

  <main class="wrap">
    <!-- LOGIN -->
    <section id="viewLogin" class="card view active">
      <h2>Ingreso al sistema</h2>
      <div class="row">
        <div>
          <label>Usuario</label>
          <input id="loginUser" placeholder="Ej:Nombre" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="loginPass" type="Contraseña" placeholder="••••••" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn-accent" onclick="doLogin()">Ingresar</button>
        <button class="btn" onclick="clearLogin()">Borrar</button>
      </div>

      <hr style="margin:12px 0;border-color:#1f2937">

      <h3 style="font-size:14px;margin:0 0 6px">Crear Cuenta</h3>
      <div class="row">
        <div>
          <label>Nuevo usuario</label>
          <input id="newUser" placeholder="Ej:Nombre" />
        </div>
        <div>
          <label>Crear Contraseña</label>
          <input id="newPass" type="Contraseña" placeholder="••••••" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn-ok" onclick="registerUser()">Registrar usuario</button>
      </div>

      <p class="small muted" style="margin-top:8px">
       <b></b> <b></b>
      </p>
    </section>

    <!-- Aplicación -->
    <div id="viewApp" class="view">
      <!-- Volver y Avanzar) -->
      <section class="card step-nav">
        <button id="btnPrev" class="btn small" style="width:auto" onclick="prevStep()">« Volver</button>
        <div class="step-title" id="stepLabel">Formularios</div>
        <button id="btnNext" class="btn small" style="width:auto" onclick="nextStep()">Avanzar »</button>
      </section>

      <!-- Contenedor 1: KPI + Formularios -->
      <div class="step-container" data-step="0">
        <!-- KPIs -->
        <section class="kpi">
          <div class="kpi-tile">
            <div class="kpi-label">Libros registrados</div>
            <div id="kpiBooks" class="kpi-value">0</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Usuarios registrados</div>
            <div id="kpiUsers" class="kpi-value">0</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Préstamos activos</div>
            <div id="kpiLoans" class="kpi-value">0</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Ejemplares disponibles</div>
            <div id="kpiAvailable" class="kpi-value">0</div>
          </div>
        </section>

        <!-- Formularios -->
        <section class="grid grid-3">
          <!-- Libro (solo admin) -->
          <div class="card" id="cardBooksForm">
            <h2>Registrar libro</h2>
            <div class="row">
              <div><label>Título</label><input id="bookTitle" placeholder="Ej:Nuevo Libro" /></div>
              <div><label>Autor</label><input id="bookAuthor" placeholder="Ej:Autor" /></div>
            </div>
            <div class="row">
              <div>
                <label>Tipo</label>
                <select id="bookType">
                  <option value="Novela">Novela</option>
                  <option value="Infantil">Infantil</option>
                  <option value="Cómic / Manga">Cómic / Manga</option>
                  <option value="Texto / Académico">Texto / Académico</option>
                  <option value="Referencia / Consulta">Referencia / Consulta</option>
                  <option value="No ficción">No ficción</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div><label>ISBN</label><input id="bookIsbn" placeholder="978-84-..." /></div>
            </div>
            <div class="row">
              <div><label>Copias</label><input id="bookQty" type="number" min="1" value="1" /></div>
              <div style="align-self:flex-end" class="row">
                <button class="btn-accent" onclick="addBook()">Guardar</button>
                <button class="btn" onclick="clearBookForm()">Limpiar</button>
              </div>
            </div>
          </div>

          <!-- Usuario -->
          <div class="card">
            <h2>Registrar usuario</h2>
            <div class="row">
              <div><label>Nombre</label><input id="userName" placeholder="Ej: Felipe Lotas" /></div>
              <div><label>Documento</label><input id="userDoc" placeholder="RUT / DNI" /></div>
            </div>
            <div class="row" style="margin-top:6px">
              <button class="btn-ok" onclick="addUser()">Guardar</button>
              <button class="btn" onclick="clearUserForm()">Limpiar</button>
            </div>
          </div>

          <!-- Préstamo (todos pueden reservar) -->
          <div class="card">
            <h2>Registrar préstamo</h2>
            <div class="row">
              <div><label>Libro</label><select id="loanBook"></select></div>
              <div><label>Usuario</label><select id="loanUser"></select></div>
            </div>
            <div class="row" style="margin-top:6px">
              <div><label>Fecha de préstamo</label><input id="loanDate" type="date" /></div>
              <div><label>Fecha estimada devolución</label><input id="loanDue" type="date" /></div>
            </div>
            <div class="row" style="margin-top:6px">
              <button class="btn-warn" onclick="addLoan()">Prestar</button>
              <button class="btn" onclick="suggestDue()">+ 14 días</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Contenedor 2: Libros / Usuarios -->
      <div class="step-container" data-step="1">
        <section class="card" style="margin-top:10px">
          <div class="toolbar">
            <div class="toolbar-search">
              <input id="search" placeholder="Buscar en libros, usuarios y préstamos…" oninput="renderAll()" />
              <input id="importFile" type="file" accept="application/json" onchange="importJson(event)" style="display:none">
              <label for="importFile" class="btn small" style="width:auto;cursor:pointer">Importar</label>
              <button class="btn small" style="width:auto" onclick="exportJson()">Exportar</button>
            </div>
            <div class="toolbar-legend">
              <span class="pill ok">Disponible</span>
              <span class="pill warn">Prestado</span>
              <span class="pill danger">Atrasado</span>
            </div>
          </div>

          <div class="grid grid-2" style="margin-top:10px">
            <div>
              <h2 style="margin-bottom:4px">Libros</h2>
              <table id="tblBooks">
                <thead>
                  <tr>
                    <th>Título</th><th>Autor</th><th>Tipo</th>
                    <th class="nowrap">Copias</th><th class="nowrap">Disp.</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div>
              <h2 style="margin-bottom:4px">Usuarios</h2>
              <table id="tblUsers">
                <thead>
                  <tr><th>Nombre</th><th>Documento</th><th>Préstamos activos</th><th></th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- Contenedor 3: Préstamos -->
      <div class="step-container" data-step="2">
        <section class="card" style="margin-top:10px">
          <h2>Préstamos</h2>
          <table id="tblLoans">
            <thead>
              <tr><th>Libro</th><th>Usuario</th><th>Salida</th><th>Vence</th><th>Estado</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </div>

      <section class="footer">
        <div>Sistema de biblioteca - Derechos reservados.</div>
      </section>
    </div>
  </main>

  <script>
    // Utilidades
    const $ = (s,root=document)=>root.querySelector(s);
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
    const KEYS = {books:"libsys_books",users:"libsys_users",loans:"libsys_loans"};
    const store = {
      get:k=>JSON.parse(localStorage.getItem(k)||'[]'),
      set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
    };

    // Control de callback genérico
    function runWithCallback(nombreAccion, callback){
      console.log("Ejecutando acción:", nombreAccion);
      if(typeof callback === "function"){ callback(); }
    }

    // Cuentas de login
    const USERS_KEY = "libsys_accounts";
    let accounts = JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
    let currentAccount = null;

    if (accounts.length === 0) {
      accounts = [
        { id: uid(), username: "admin", password: "1234", role: "admin" }
      ];
      saveAccounts();
    }

    function saveAccounts() {
      localStorage.setItem(USERS_KEY, JSON.stringify(accounts));
    }

    function isAdmin() {
      return currentAccount && currentAccount.role === "admin";
    }

    function applyRolePermissions() {
      // Ocultar/mostrar formulario de libros
      const cardBooksForm = document.getElementById("cardBooksForm");
      if (cardBooksForm) {
        cardBooksForm.style.display = isAdmin() ? "" : "none";
      }
      
      renderBooks();
    }

    let books = store.get(KEYS.books);
    let users = store.get(KEYS.users);
    let loans = store.get(KEYS.loans);

    // Navegación entre contenedores
    let currentStep = 0;
    function showStep(idx){
      const steps = document.querySelectorAll(".step-container");
      if(!steps.length) return;
      if(idx < 0) idx = 0;
      if(idx > steps.length - 1) idx = steps.length - 1;
      currentStep = idx;
      steps.forEach((s,i)=>s.classList.toggle("active", i===currentStep));

      const titles = [
        "Formularios",
        "Libros y usuarios",
        "Préstamos"
      ];
      $("#stepLabel").textContent = titles[currentStep] || `Vista ${currentStep+1}`;
      $("#btnPrev").disabled = currentStep === 0;
      $("#btnNext").disabled = currentStep === steps.length - 1;
    }
    function prevStep(){ showStep(currentStep - 1); }
    function nextStep(){ showStep(currentStep + 1); }

    // Login
    function doLogin(){
      const u = $("#loginUser").value.trim();
      const p = $("#loginPass").value.trim();

      if(!u || !p){
        alert("Debes ingresar usuario y contraseña.");
        return;
      }

      const acc = accounts.find(a => a.username === u && a.password === p);

      if (acc) {
        currentAccount = acc; 
        runWithCallback("login", () => {
          $("#viewLogin").classList.remove("active");
          $("#viewApp").classList.add("active");
          $("#btnLogout").style.display = "inline-flex";
          showStep(0);
          applyRolePermissions(); 
        });
      } else {
        alert("Usuario o contraseña incorrectos.");
      }
    }

    function registerUser(){
      const u = $("#newUser").value.trim();
      const p = $("#newPass").value.trim();

      if(!u || !p){
        alert("Debes ingresar un nombre de usuario y una contraseña.");
        return;
      }

      if(accounts.some(a => a.username === u)){
        alert("Ya existe un usuario con ese nombre.");
        return;
      }

      accounts.push({
        id: uid(),
        username: u,
        password: p,
        role: "user"  
      });

      saveAccounts();

      $("#newUser").value = "";
      $("#newPass").value = "";

      alert("Usuario creado. Ahora puedes iniciar sesión.");
    }

    function clearLogin(){
      $("#loginUser").value = "";
      $("#loginPass").value = "";
    }

    function logout(){
      runWithCallback("logout", () => {
        currentAccount = null;
        $("#viewApp").classList.remove("active");
        $("#viewLogin").classList.add("active");
        $("#btnLogout").style.display = "none";
        clearLogin();
      });
    }

    //Demo
    if(books.length===0 && users.length===0 && loans.length===0){
      books = [
        {id:uid(),title:"El nombre del viento",author:"Patrick Rothfuss",isbn:"9788401352836",qty:3,type:"Novela"},
        {id:uid(),title:"Cien años de soledad",author:"G. García Márquez",isbn:"9780307474728",qty:2,type:"Novela"},
        {id:uid(),title:"Fundación",author:"Isaac Asimov",isbn:"9788497594257",qty:4,type:"No ficción"},
        {id:uid(),title:"The Legend Of Zelda",author:"Akira Himekawa",isbn:"9788497554673",qty:4,type:"Manga"},
        {id:uid(),title:"All You Need Is Kill",author:"Hiroshi Sakurazaka",isbn:"97884975944356",qty:4,type:"Manga"}
      ];
      users = [
        {id:uid(),name:"Ana Cotate",doc:"12.345.678-9"},
        {id:uid(),name:"Mikola Pesta",doc:"9.876.543-2"},
        {id:uid(),name:"Helena Nito",doc:"25.789.456-1"},
      ];
      const d = todayISO();
      loans = [{id:uid(),bookId:books[0].id,userId:users[1].id,outAt:d,dueAt:addDays(d,7),returnedAt:null}];
      persist();
    }
    function persist(){
      store.set(KEYS.books,books);
      store.set(KEYS.users,users);
      store.set(KEYS.loans,loans);
    }
    function addDays(dateISO,days){
      const d=new Date(dateISO); d.setDate(d.getDate()+days);
      return d.toISOString().slice(0,10);
    }

    // Libros
    function addBook(){
      if (!isAdmin()) {
        alert("Solo el administrador puede agregar libros.");
        return;
      }
      const title=$("#bookTitle").value.trim();
      const author=$("#bookAuthor").value.trim();
      const isbn=$("#bookIsbn").value.trim();
      const type=$("#bookType").value||"Otro";
      const qty=Math.max(1,parseInt($("#bookQty").value||"1",10));
      if(!title||!author){
        alert("Título y Autor son obligatorios.");
        return;
      }
      books.push({id:uid(),title,author,isbn,qty,type});
      runWithCallback("guardarLibro", () => {
        persist(); clearBookForm(); renderAll();
      });
    }
    function clearBookForm(){
      $("#bookTitle").value="";
      $("#bookAuthor").value="";
      $("#bookIsbn").value="";
      $("#bookQty").value=1;
      $("#bookType").value="Novela";
    }
    function deleteBook(id){
      if (!isAdmin()) {
        alert("Solo el administrador puede eliminar libros.");
        return;
      }
      const active=loans.some(l=>l.bookId===id && !l.returnedAt);
      if(active){
        alert("No puedes eliminar un libro con préstamos activos.");
        return;
      }
      books=books.filter(b=>b.id!==id);
      runWithCallback("eliminarLibro", () => {
        persist(); renderAll();
      });
    }

    // Usuarios
    function addUser(){
      const name=$("#userName").value.trim();
      const doc=$("#userDoc").value.trim();
      if(!name||!doc){
        alert("Nombre y Documento son obligatorios.");
        return;
      }
      users.push({id:uid(),name,doc});
      runWithCallback("guardarUsuario", () => {
        persist(); clearUserForm(); renderAll();
      });
    }
    function clearUserForm(){
      $("#userName").value="";
      $("#userDoc").value="";
    }
    function deleteUser(id){
      const active=loans.some(l=>l.userId===id && !l.returnedAt);
      if(active){
        alert("No puedes eliminar un usuario con préstamos activos.");
        return;
      }
      users=users.filter(u=>u.id!==id);
      runWithCallback("eliminarUsuario", () => {
        persist(); renderAll();
      });
    }

    // Préstamos (reservar)
    function availableCopies(bookId){
      const book=books.find(b=>b.id===bookId); if(!book) return 0;
      const borrowed=loans.filter(l=>l.bookId===bookId && !l.returnedAt).length;
      return Math.max(0,(book.qty||0)-borrowed);
    }
    function addLoan(){
      const bookId=$("#loanBook").value;
      const userId=$("#loanUser").value;
      const outAt=$("#loanDate").value||todayISO();
      const dueAt=$("#loanDue").value||addDays(outAt,14);
      if(!bookId||!userId){
        alert("Debes seleccionar libro y usuario.");
        return;
      }
      if(availableCopies(bookId)<=0){
        alert("No hay copias disponibles para este libro.");
        return;
      }
      loans.push({id:uid(),bookId,userId,outAt,dueAt,returnedAt:null});
      runWithCallback("prestarLibro", () => {
        persist(); renderAll();
      });
    }
    function returnLoan(id){
      const l=loans.find(x=>x.id===id); if(!l) return;
      if(l.returnedAt){
        alert("Este préstamo ya fue devuelto.");
        return;
      }
      l.returnedAt=todayISO();
      runWithCallback("devolverLibro", () => {
        persist(); renderAll();
      });
    }
    function deleteLoan(id){
      loans=loans.filter(l=>l.id!==id);
      runWithCallback("eliminarPrestamo", () => {
        persist(); renderAll();
      });
    }

    // Import/Export
    function exportJson(){
      const data={books,users,loans,exportedAt:new Date().toISOString()};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="biblioteca.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importJson(ev){
      const file=ev.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const data=JSON.parse(reader.result);
          if(!data.books||!data.users||!data.loans) throw new Error("Archivo inválido");
          books=data.books; users=data.users; loans=data.loans;
          runWithCallback("importarDatos", () => {
            persist(); renderAll(); alert("Datos importados correctamente.");
          });
        }catch(e){
          alert("No se pudo importar: "+e.message);
        }
      };
      reader.readAsText(file);
    }

    // Render
    function renderAll(){
      renderCombos();
      renderKpis();
      renderBooks();
      renderUsers();
      renderLoans();
    }
    function renderCombos(){
      const bookSel=$("#loanBook"), userSel=$("#loanUser");
      bookSel.innerHTML='<option value="">— Selecciona —</option>'+books.map(b=>{
        const disp=availableCopies(b.id), type=b.type||"—";
        return `<option value="${b.id}">${escapeHtml(b.title)} (${escapeHtml(type)}) — ${disp}/${b.qty} disp.</option>`;
      }).join("");
      userSel.innerHTML='<option value="">— Selecciona —</option>'+users.map(u=>
        `<option value="${u.id}">${escapeHtml(u.name)} (${escapeHtml(u.doc)})</option>`
      ).join("");
    }
    function renderKpis(){
      const active=loans.filter(l=>!l.returnedAt).length;
      const available=books.reduce((acc,b)=>acc+availableCopies(b.id),0);
      $("#kpiBooks").textContent=books.length;
      $("#kpiUsers").textContent=users.length;
      $("#kpiLoans").textContent=active;
      $("#kpiAvailable").textContent=available;
    }
    function renderBooks(){
      const q=($("#search")?.value||"").toLowerCase();
      const tb=document.querySelector("#tblBooks tbody"); if(!tb) return;
      tb.innerHTML="";
      books
        .filter(b=>!q?true:[b.title,b.author,b.isbn,b.type].some(x=>(x||"").toLowerCase().includes(q)))
        .forEach(b=>{
          const actionsHtml = isAdmin()
            ? `
              <button class="btn small" onclick="editBookPrompt('${b.id}')">Editar</button>
              <button class="btn-danger small" onclick="deleteBook('${b.id}')">Eliminar</button>
              `
            : ""; 
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${escapeHtml(b.title)}</td>
            <td>${escapeHtml(b.author)}</td>
            <td>${escapeHtml(b.type||"—")}</td>
            <td>${b.qty}</td>
            <td>${availableCopies(b.id)}</td>
            <td class="actions">
              ${actionsHtml}
            </td>`;
          tb.appendChild(tr);
        });
    }
    function renderUsers(){
      const q=($("#search")?.value||"").toLowerCase();
      const tb=document.querySelector("#tblUsers tbody"); if(!tb) return;
      tb.innerHTML="";
      users
        .filter(u=>!q?true:[u.name,u.doc].some(x=>(x||"").toLowerCase().includes(q)))
        .forEach(u=>{
          const count=loans.filter(l=>l.userId===u.id && !l.returnedAt).length;
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${escapeHtml(u.name)}</td>
            <td>${escapeHtml(u.doc)}</td>
            <td>${count}</td>
            <td class="actions">
              <button class="btn small" onclick="editUserPrompt('${u.id}')">Editar</button>
              <button class="btn-danger small" onclick="deleteUser('${u.id}')">Eliminar</button>
            </td>`;
          tb.appendChild(tr);
        });
    }
    function renderLoans(){
      const q=($("#search")?.value||"").toLowerCase();
      const tb=document.querySelector("#tblLoans tbody"); if(!tb) return;
      tb.innerHTML="";
      loans
        .filter(l=>{
          if(!q) return true;
          const b=books.find(x=>x.id===l.bookId), u=users.find(x=>x.id===l.userId);
          return [b?.title,b?.author,u?.name,u?.doc,l.outAt,l.dueAt]
            .some(x=>(x||"").toLowerCase().includes(q));
        })
        .sort((a,b)=>(b.returnedAt?0:1)-(a.returnedAt?0:1))
        .forEach(l=>{
          const b=books.find(x=>x.id===l.bookId), u=users.find(x=>x.id===l.userId);
          const status=loanStatus(l);
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${escapeHtml(b?.title||"—")}</td>
            <td>${escapeHtml(u?.name||"—")}</td>
            <td>${fmtDate(l.outAt)}</td>
            <td>${fmtDate(l.dueAt)}</td>
            <td>${statusBadge(status)}</td>
            <td class="actions">
              ${!l.returnedAt?`<button class="btn-ok small" onclick="returnLoan('${l.id}')">Devolver</button>`:""}
              <button class="btn small" onclick="editLoanPrompt('${l.id}')">Editar</button>
              <button class="btn-danger small" onclick="deleteLoan('${l.id}')">Eliminar</button>
            </td>`;
          tb.appendChild(tr);
        });
    }

    // Helpers
    function statusBadge(s){
      const cls=s==="Atrasado"?"danger":(s==="Prestado"?"warn":"ok");
      return `<span class="pill ${cls}">${s}</span>`;
    }
    function loanStatus(l){
      if(l.returnedAt) return "Devuelto";
      const now=todayISO();
      return l.dueAt<now?"Atrasado":"Prestado";
    }
    function fmtDate(iso){
      if(!iso) return "—";
      const [y,m,d]=iso.split("-");
      return `${d}/${m}/${y}`;
    }
    function suggestDue(){
      const d=$("#loanDate").value||todayISO();
      $("#loanDate").value=d;
      $("#loanDue").value=addDays(d,14);
    }
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g,m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    // Prompts de edición rápida
    function editBookPrompt(id){
      if (!isAdmin()) {
        alert("Solo el administrador puede editar libros.");
        return;
      }
      const b=books.find(x=>x.id===id); if(!b) return;
      const title=prompt("Título",b.title); if(title===null) return;
      const author=prompt("Autor",b.author); if(author===null) return;
      const type=prompt("Tipo (ej: Novela, Infantil…)",b.type||""); if(type===null) return;
      const isbn=prompt("ISBN (opcional)",b.isbn||""); if(isbn===null) return;
      const qty=parseInt(prompt("Copias",b.qty),10);
      if(Number.isNaN(qty)||qty<1){
        alert("Cantidad inválida");
        return;
      }
      if(qty<loans.filter(l=>l.bookId===id && !l.returnedAt).length){
        alert("No puedes reducir copias por debajo de los préstamos activos.");
        return;
      }
      Object.assign(b,{title,author,isbn,qty,type});
      runWithCallback("editarLibro", () => {
        persist(); renderAll();
      });
    }
    function editUserPrompt(id){
      const u=users.find(x=>x.id===id); if(!u) return;
      const name=prompt("Nombre",u.name); if(name===null) return;
      const doc=prompt("Documento",u.doc); if(doc===null) return;
      Object.assign(u,{name,doc});
      runWithCallback("editarUsuario", () => {
        persist(); renderAll();
      });
    }
    function editLoanPrompt(id){
      const l=loans.find(x=>x.id===id); if(!l) return;
      const outAt=prompt("Fecha préstamo (YYYY-MM-DD)",l.outAt); if(outAt===null) return;
      const dueAt=prompt("Fecha vence (YYYY-MM-DD)",l.dueAt); if(dueAt===null) return;
      const returnedAt=prompt("Fecha devolución (YYYY-MM-DD o vacío)",l.returnedAt||""); if(returnedAt===null) return;
      l.outAt=outAt; l.dueAt=dueAt; l.returnedAt=returnedAt===""?null:returnedAt;
      runWithCallback("editarPrestamo", () => {
        persist(); renderAll();
      });
    }

    // Init
    (function init(){
      $("#loanDate").value=todayISO();
      $("#loanDue").value=addDays(todayISO(),14);
      renderAll();
      showStep(0);
      applyRolePermissions(); 
    })();
  </script>
</body>
</html>
